import React, { useState, useRef, useEffect } from 'react';
import './AttendanceScreen.css';

const AttendanceScreen = () => {
  const [recognitionStatus, setRecognitionStatus] = useState({
    message: 'Vui l√≤ng nh√¨n v√†o camera ƒë·ªÉ ƒëi·ªÉm danh',
    user: '',
    timestamp: ''
  });
  const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);
  const [employeeCode, setEmployeeCode] = useState('');
  const [isRecognizing, setIsRecognizing] = useState(false);
  const [frameClass, setFrameClass] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [errorMessage, setErrorMessage] = useState('');
  const [highlight, setHighlight] = useState(false);
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const inputRef = useRef(null);

  // URL c∆° b·∫£n c·ªßa API backend
  const API_BASE_URL = 'http://192.168.1.10:5000/attendances'; // Thay b·∫±ng IP th·ª±c t·∫ø

  useEffect(() => {
    if (isLoginModalOpen && inputRef.current) {
      inputRef.current.focus();
    }
  }, [isLoginModalOpen]);

  useEffect(() => {
    const startCamera = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        if (videoRef.current) videoRef.current.srcObject = stream;
      } catch (error) {
        console.error('Kh√¥ng th·ªÉ truy c·∫≠p camera:', error);
        setRecognitionStatus({
          message: 'Kh√¥ng th·ªÉ truy c·∫≠p camera',
          user: '',
          timestamp: ''
        });
      }
    };
    startCamera();

    // B·∫Øt ƒë·∫ßu nh·∫≠n di·ªán khu√¥n m·∫∑t m·ªói 3 gi√¢y
    const recognitionInterval = setInterval(() => {
      if (!isRecognizing && videoRef.current && canvasRef.current) {
        recognizeFace();
      }
    }, 3000);

    return () => clearInterval(recognitionInterval);
  }, []);

  const captureFrame = () => {
    if (!videoRef.current || !canvasRef.current) return null;
    const canvas = canvasRef.current;
    const video = videoRef.current;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    return canvas.toDataURL('image/jpeg');
  };

  const recognizeFace = async () => {
    setIsRecognizing(true);
    setRecognitionStatus({
      message: 'ƒêang nh·∫≠n di·ªán khu√¥n m·∫∑t...',
      user: '',
      timestamp: ''
    });

    try {
      const imageDataUrl = captureFrame();
      if (!imageDataUrl) {
        throw new Error('Kh√¥ng th·ªÉ ch·ª•p khung h√¨nh');
      }

      const response = await fetch(imageDataUrl);
      const blob = await response.blob();
      const formData = new FormData();
      formData.append('image', blob, 'frame.jpg');

      const recognizeResponse = await fetch(`${API_BASE_URL}/recognize_face`, {
        method: 'POST',
        body: formData,
      });

      const recognizeData = await recognizeResponse.json();

      if (recognizeResponse.ok) {
        const { employee_id, employee_name } = recognizeData;
        await recordAttendance(employee_id, employee_name, 'Nh·∫≠n di·ªán khu√¥n m·∫∑t');
      } else {
        setRecognitionStatus({
          message: recognizeData.error || 'Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c khu√¥n m·∫∑t',
          user: '',
          timestamp: ''
        });
        setFrameClass('fail');
        setTimeout(() => setFrameClass(''), 1000);
      }
    } catch (error) {
      console.error('L·ªói khi nh·∫≠n di·ªán khu√¥n m·∫∑t:', error);
      setRecognitionStatus({
        message: 'L·ªói k·∫øt n·ªëi ho·∫∑c nh·∫≠n di·ªán th·∫•t b·∫°i',
        user: '',
        timestamp: ''
      });
      setFrameClass('fail');
      setTimeout(() => setFrameClass(''), 1000);
    } finally {
      setIsRecognizing(false);
    }
  };

  const recordAttendance = async (employeeId, employeeName, source) => {
    try {
      const response = await fetch(`${API_BASE_URL}/record`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ employee_id: parseInt(employeeId) }),
      });

      const data = await response.json();

      if (response.ok) {
        setRecognitionStatus({
          message: data.message || `ƒêi·ªÉm danh th√†nh c√¥ng qua ${source}!`,
          user: employeeName || employeeId,
          timestamp: new Date().toLocaleString()
        });
        setFrameClass('success');
        setTimeout(() => setFrameClass(''), 1000);
      } else {
        setRecognitionStatus({
          message: data.error || 'ƒêi·ªÉm danh th·∫•t b·∫°i',
          user: '',
          timestamp: ''
        });
        setFrameClass('fail');
        setTimeout(() => setFrameClass(''), 1000);
      }
    } catch (error) {
      console.error('L·ªói khi ghi nh·∫≠n ƒëi·ªÉm danh:', error);
      setRecognitionStatus({
        message: 'L·ªói k·∫øt n·ªëi server',
        user: '',
        timestamp: ''
      });
      setFrameClass('fail');
      setTimeout(() => setFrameClass(''), 1000);
    }
  };

  const handleRetry = () => {
    recognizeFace();
  };

  const handleLoginSubmit = async (e) => {
    e.preventDefault();
    setErrorMessage('');
    setIsSubmitting(true);

    if (!employeeCode) {
      setErrorMessage('Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng m√£ nh√¢n vi√™n');
      setIsSubmitting(false);
      return;
    }

    if (!/^\d+$/.test(employeeCode)) {
      setErrorMessage('M√£ nh√¢n vi√™n ch·ªâ ƒë∆∞·ª£c ch·ª©a s·ªë');
      setIsSubmitting(false);
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/record`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ employee_id: parseInt(employeeCode) }),
      });

      const data = await response.json();

      if (response.ok) {
        setRecognitionStatus({
          message: data.message || 'ƒêi·ªÉm danh th√†nh c√¥ng!',
          user: employeeCode, // Backend kh√¥ng tr·∫£ employee_name
          timestamp: new Date().toLocaleString()
        });
        setIsLoginModalOpen(false);
        setEmployeeCode('');
        setFrameClass('success');
        setTimeout(() => setFrameClass(''), 1000);
      } else {
        setErrorMessage(data.error || 'M√£ nh√¢n vi√™n kh√¥ng t·ªìn t·∫°i');
      }
    } catch (error) {
      console.error('L·ªói khi g·ªçi API:', error);
      setErrorMessage('L·ªói k·∫øt n·ªëi server');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleKeyPress = (key) => {
    if (key === 'Clear') {
      setEmployeeCode('');
    } else if (key === 'Backspace') {
      setEmployeeCode(employeeCode.slice(0, -1));
    } else if (key === 'Enter') {
      handleLoginSubmit(new Event('submit'));
    } else {
      setEmployeeCode(employeeCode + key);
      setHighlight(true);
      setTimeout(() => setHighlight(false), 200);
    }
  };

  const handleCloseModal = (e) => {
    if (e.target.className === 'login-modal') {
      setIsLoginModalOpen(false);
      setEmployeeCode('');
      setErrorMessage('');
    }
  };

  const NumericKeyboard = () => {
    const keys = [
      ['1', '2', '3'],
      ['4', '5', '6'],
      ['7', '8', '9'],
      ['Backspace', '0', 'Clear'],
      ['Enter']
    ];

    return (
      <div className="numeric-keyboard">
        {keys.map((row, rowIndex) => (
          <div key={rowIndex} className="keyboard-row">
            {row.map((key) => (
              <div key={key} className="key-wrapper">
                <button
                  className={`keyboard-key ${key === 'Backspace' || key === 'Enter' || key === 'Clear' ? 'special-key' : ''} ${key === 'Enter' ? 'enter' : ''}`}
                  onClick={() => handleKeyPress(key)}
                >
                  {key === 'Backspace' ? '‚å´' : key === 'Enter' ? '‚ûú' : key === 'Clear' ? 'üóëÔ∏è' : key}
                </button>
                {key === 'Backspace' && <span className="key-label">X√≥a</span>}
                {key === 'Clear' && <span className="key-label">X√≥a to√†n b·ªô</span>}
              </div>
            ))}
          </div>
        ))}
      </div>
    );
  };

  return (
    <div className="attendance-container">
      <div className="camera-section">
        <video ref={videoRef} autoPlay playsInline className="camera-feed" />
        <canvas ref={canvasRef} style={{ display: 'none' }} />
        <div className={`recognition-frame ${frameClass}`}>
          {isRecognizing && <div className="spinner"></div>}
        </div>
      </div>
      <div className="status-section">
        <div className="status-message">
          <p>
            {recognitionStatus.message.includes('th√†nh c√¥ng') ? (
              <span className="icon">‚úîÔ∏è </span>
            ) : null}
            {recognitionStatus.message}
          </p>
          {recognitionStatus.user && (
            <p>
              <span className="icon">üëã </span>
              Ch√†o {recognitionStatus.user}
            </p>
          )}
          {recognitionStatus.timestamp && (
            <p>
              <span className="icon">‚è∞ </span>
              {recognitionStatus.timestamp}
            </p>
          )}
        </div>
      </div>
      <div className="support-buttons">
        <button className="retry-btn" onClick={handleRetry}>üîÅ Qu√©t l·∫°i khu√¥n m·∫∑t</button>
        <button className="login-btn" onClick={() => setIsLoginModalOpen(true)}>‚úç Nh·∫≠p m√£ nh√¢n vi√™n</button>
      </div>
      {isLoginModalOpen && (
        <div className="login-modal" onClick={handleCloseModal}>
          <div className="modal-content">
            <h3>Nh·∫≠p m√£ nh√¢n vi√™n</h3>
            <form onSubmit={handleLoginSubmit}>
              <div className="form-group">
                <input
                  type="text"
                  value={employeeCode}
                  onChange={(e) => setEmployeeCode(e.target.value)}
                  required
                  ref={inputRef}
                  className={highlight ? 'highlight' : ''}
                />
                {errorMessage && <p className="error-message">{errorMessage}</p>}
              </div>
              <button type="submit" className="submit-btn" disabled={isSubmitting}>
                {isSubmitting ? <div className="spinner small"></div> : 'ƒêi·ªÉm danh'}
              </button>
            </form>
            <NumericKeyboard />
          </div>
        </div>
      )}
    </div>
  );
};

export default AttendanceScreen;